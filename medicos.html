<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Médicos</title>
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #adb5bd;
            --background-color: #212529;
            --surface-color: #2b3035;
            --text-color: #dee2e6;
            --border-color: #495057;
            --blue-view: #0dcaf0;
            --yellow-edit: #ffc107;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 20px; }
        .container { max-width: 1600px; margin: auto; background: var(--surface-color); padding: 25px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { color: #fff; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .filters-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .filters-container input[type="text"] { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; background-color: var(--background-color); color: var(--text-color); }
        .multi-select-container { position: relative; }
        .multi-select-button { background-color: var(--surface-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 10px 15px; border-radius: 4px; cursor: pointer; width: 200px; text-align: left; }
        .multi-select-dropdown {
            display: none; position: absolute; background-color: var(--surface-color); border: 1px solid var(--border-color);
            border-radius: 4px; padding: 10px; z-index: 100; max-height: 250px; overflow-y: auto; width: 250px;
        }
        .multi-select-dropdown label { display: block; margin-bottom: 8px; cursor: pointer; }
        .multi-select-dropdown label:hover { color: var(--primary-color); }
        .multi-select-dropdown input[type="checkbox"] { margin-right: 8px; }
        .dropdown-search-input {
            width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;
            border: 1px solid var(--border-color); border-radius: 4px;
            background-color: var(--background-color); color: var(--text-color);
        }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: #343a40; font-size: 1.1em; }
        tr:nth-of-type(even) { background-color: #2c3034; }
        tr:hover { background-color: #3a4045; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: 600; text-decoration: none; display: inline-block; margin-right: 5px; background-color: var(--primary-color); color: white; }
        .btn-view { background-color: var(--blue-view); color: #000; padding: 6px 12px; font-size: 0.9em; }
        .btn-edit { background-color: var(--yellow-edit); color: #000; padding: 6px 12px; font-size: 0.9em; }
        th[data-column] { cursor: pointer; position: relative; }
        th[data-column]::after { content: ' \2195'; opacity: 0.4; position: absolute; right: 10px; }
        th.sort-asc::after { content: ' \2191'; opacity: 1; }
        th.sort-desc::after { content: ' \2193'; opacity: 1; }
        .name-link { color: inherit; text-decoration: none; }
        .name-link:hover { text-decoration: underline; }
        tfoot td { text-align: center; padding: 20px; }
    </style>
</head>
<body>
  <div class="container">
    <h1>Lista de Médicos</h1>
    <div class="filters-container">
        <input type="text" id="search-input" placeholder="Pesquisar por nome...">
        <input type="text" id="cedula-input" placeholder="Pesquisar por cédula...">
        <div class="multi-select-container"><button class="multi-select-button">Especialidades</button><div class="multi-select-dropdown" id="especialidades-filter"></div></div>
        <div class="multi-select-container"><button class="multi-select-button">Sub-Especialidades</button><div class="multi-select-dropdown" id="sub-especialidades-filter"></div></div>
        <div class="multi-select-container"><button class="multi-select-button">Hospitais</button><div class="multi-select-dropdown" id="hospitais-filter"></div></div>
        <div class="multi-select-container"><button class="multi-select-button">Serviços</button><div class="multi-select-dropdown" id="servicos-filter"></div></div>
    </div>
    <div style="overflow-x:auto;">
         <table>
            <thead>
                <tr>
                    <th data-column="nome">Nome</th>
                    <th data-column="specialtyNames">Especialidade</th>
                    <!-- MODIFICAÇÃO 1: Colunas trocadas no cabeçalho -->
                    <th data-column="hospitalNames">Hospital</th>
                    <th data-column="subSpecialtyNames">Sub-Especialidade</th>
                    <th data-column="serviceNames">Serviço</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="doctors-table-body">
                <tr><td colspan="6" style="text-align: center;">A carregar médicos...</td></tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="6">
                        <button id="show-more-btn" class="btn" style="display: none;">Mostrar mais 50</button>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBPT8jKrdXIs5Hupd13BwBwd4GxaWQrNdM",
        authDomain: "medical-5baa0.firebaseapp.com",
        projectId: "medical-5baa0",
        storageBucket: "medical-5baa0.appspot.com",
        messagingSenderId: "900547659131",
        appId: "1:900547659131:web:708f90f8fa1500d76569de"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allDoctorsData = [];
    let currentSort = { column: 'nome', direction: 'asc' };

    const ITEMS_PER_PAGE = 50;
    let visibleItemsCount = ITEMS_PER_PAGE;

    const tableBody = document.getElementById('doctors-table-body');
    const searchInput = document.getElementById('search-input');
    const cedulaInput = document.getElementById('cedula-input');
    const showMoreBtn = document.getElementById('show-more-btn');

    function renderTable(dataToRender) {
        if (dataToRender.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum médico corresponde aos filtros.</td></tr>';
            return;
        }
        const rowsHtml = dataToRender.map(doc => `
            <tr>
                <td><a href="medico.html?id=${doc.id}" class="name-link">${doc.nome}</a></td>
                <td>${doc.specialtyNames}</td>
                <!-- MODIFICAÇÃO 2: Colunas trocadas no corpo da tabela -->
                <td>${doc.hospitalNames}</td>
                <td>${doc.subSpecialtyNames}</td>
                <td>${doc.serviceNames}</td>
                <td>
                    <a href="medico.html?id=${doc.id}" class="btn btn-view">Ver</a>
                    <a href="master.html?edit=medico&id=${doc.id}" class="btn btn-edit">Editar</a>
                </td>
            </tr>
        `).join('');
        tableBody.innerHTML = rowsHtml;
    }

    function populateMultiSelect(containerId, dataMap) {
        const container = document.getElementById(containerId);
        const sortedData = [...dataMap.entries()].sort((a, b) => a[1].localeCompare(b[1]));
        let html = `<input type="text" class="dropdown-search-input" placeholder="Filtrar...">`;
        html += sortedData.map(([id, name]) => `<label><input type="checkbox" value="${id}"> ${name}</label>`).join('');
        container.innerHTML = html;
    }

    function setupDropdownSearchListeners() {
        document.querySelectorAll('.multi-select-dropdown').forEach(dropdown => {
            const searchInput = dropdown.querySelector('.dropdown-search-input');
            if (searchInput) {
                searchInput.addEventListener('click', (e) => e.stopPropagation());
                searchInput.addEventListener('input', (e) => {
                    const filterText = e.target.value.toLowerCase();
                    const labels = dropdown.querySelectorAll('label');
                    labels.forEach(label => {
                        const labelText = label.textContent.toLowerCase();
                        label.style.display = labelText.includes(filterText) ? 'block' : 'none';
                    });
                });
            }
        });
    }

    async function loadAndPrepareData() {
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">A carregar dados...</td></tr>';
        try {
            const [medicosSnap, especialidadesSnap, hospitaisSnap, servicosSnap] = await Promise.all([
                getDocs(collection(db, "medicos")),
                getDocs(collection(db, "especialidade")),
                getDocs(collection(db, "hospitais")),
                getDocs(collection(db, "servicos"))
            ]);
            const specialtiesMap = new Map(especialidadesSnap.docs.map(doc => [doc.id, doc.data().nome]));
            const hospitalsMap = new Map(hospitaisSnap.docs.map(doc => {
                const data = doc.data();
                const nome = data.nome || '';
                const sigla = data.sigla || '';
                const displayName = (sigla && sigla.trim() !== '') ? `${nome} (${sigla})` : nome;
                return [doc.id, displayName];
            }));
            const servicesMap = new Map(servicosSnap.docs.map(doc => [doc.id, doc.data().nome]));

            populateMultiSelect('especialidades-filter', specialtiesMap);
            populateMultiSelect('sub-especialidades-filter', specialtiesMap);
            populateMultiSelect('hospitais-filter', hospitalsMap);
            populateMultiSelect('servicos-filter', servicesMap);
            setupDropdownSearchListeners();

            allDoctorsData = medicosSnap.docs.map(doc => {
                const medico = doc.data();
                const posicoes = medico.posicoes || [];
                const hospitalNames = [...new Set(posicoes.map(p => hospitalsMap.get(p.hospital_id)).filter(Boolean))].join('<br>');
                const serviceNames = [...new Set(posicoes.map(p => servicesMap.get(p.servico_id)).filter(Boolean))].join('<br>');
                return {
                    id: doc.id,
                    nome: medico.nome || '',
                    nome_completo: medico.nome_completo || '',
                    cedula: medico.cedula || '',
                    especialidade_ids: medico.especialidade_ids || [],
                    sub_especialidade_ids: medico.sub_especialidade_ids || [],
                    posicoes: posicoes,
                    specialtyNames: (medico.especialidade_ids || []).map(id => specialtiesMap.get(id)).join('<br>') || 'N/A',
                    subSpecialtyNames: (medico.sub_especialidade_ids || []).map(id => specialtiesMap.get(id)).join('<br>') || 'N/A',
                    hospitalNames: hospitalNames || 'N/A',
                    serviceNames: serviceNames || 'N/A',
                };
            });
            filterAndSortAndRender();
        } catch (error) {
            console.error("Erro ao carregar dados:", error);
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ocorreu um erro.</td></tr>';
        }
    }

    function filterAndSortAndRender() {
        const searchTerm = searchInput.value.toLowerCase();
        const cedulaTerm = cedulaInput.value.toLowerCase();
        const getSelectedIds = (containerId) => [...document.querySelectorAll(`#${containerId} input:checked`)].map(cb => cb.value);
        const selectedSpecialties = getSelectedIds('especialidades-filter');
        const selectedSubSpecialties = getSelectedIds('sub-especialidades-filter');
        const selectedHospitals = getSelectedIds('hospitais-filter');
        const selectedServices = getSelectedIds('servicos-filter');

        let filteredAndSortedData = allDoctorsData.filter(doc => {
            const nameMatch = doc.nome.toLowerCase().includes(searchTerm) || doc.nome_completo.toLowerCase().includes(searchTerm);
            const cedulaMatch = !cedulaTerm || doc.cedula.toLowerCase().includes(cedulaTerm);
            const specialtyMatch = selectedSpecialties.length === 0 || selectedSpecialties.some(id => doc.especialidade_ids.includes(id));
            const subSpecialtyMatch = selectedSubSpecialties.length === 0 || selectedSubSpecialties.some(id => doc.sub_especialidade_ids.includes(id));
            const hospitalMatch = selectedHospitals.length === 0 || doc.posicoes.some(p => selectedHospitals.includes(p.hospital_id));
            const serviceMatch = selectedServices.length === 0 || doc.posicoes.some(p => selectedServices.includes(p.servico_id));
            return nameMatch && cedulaMatch && specialtyMatch && subSpecialtyMatch && hospitalMatch && serviceMatch;
        });

        filteredAndSortedData.sort((a, b) => {
            const valA = a[currentSort.column] || '';
            const valB = b[currentSort.column] || '';
            const comparison = valA.toString().localeCompare(valB.toString(), undefined, { numeric: true });
            return currentSort.direction === 'asc' ? comparison : -comparison;
        });
        
        const isAnyFilterActive = searchTerm || cedulaTerm || selectedSpecialties.length > 0 || selectedSubSpecialties.length > 0 || selectedHospitals.length > 0 || selectedServices.length > 0;
        
        if (isAnyFilterActive) {
            renderTable(filteredAndSortedData);
            showMoreBtn.style.display = 'none';
        } else {
            const dataToShow = filteredAndSortedData.slice(0, visibleItemsCount);
            renderTable(dataToShow);

            if (visibleItemsCount < filteredAndSortedData.length) {
                showMoreBtn.style.display = 'block';
            } else {
                showMoreBtn.style.display = 'none';
            }
        }
    }

    function handleFilterChange() {
        visibleItemsCount = ITEMS_PER_PAGE;
        filterAndSortAndRender();
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadAndPrepareData();

        searchInput.addEventListener('input', handleFilterChange);
        cedulaInput.addEventListener('input', handleFilterChange);
        document.getElementById('especialidades-filter').addEventListener('change', handleFilterChange);
        document.getElementById('sub-especialidades-filter').addEventListener('change', handleFilterChange);
        document.getElementById('hospitais-filter').addEventListener('change', handleFilterChange);
        document.getElementById('servicos-filter').addEventListener('change', handleFilterChange);
        
        showMoreBtn.addEventListener('click', () => {
            visibleItemsCount += ITEMS_PER_PAGE;
            filterAndSortAndRender();
        });

        document.querySelector('thead').addEventListener('click', e => {
            const header = e.target.closest('th[data-column]');
            if (!header) return;
            const column = header.dataset.column;
            const direction = (currentSort.column === column && currentSort.direction === 'asc') ? 'desc' : 'asc';
            currentSort = { column, direction };
            document.querySelectorAll('th[data-column]').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
            header.classList.add(`sort-${direction}`);
            handleFilterChange();
        });
        
        document.querySelectorAll('.multi-select-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdown = button.nextElementSibling;
                const isCurrentlyOpen = dropdown.style.display === 'block';
                document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                    d.style.display = 'none';
                });
                if (!isCurrentlyOpen) {
                    dropdown.style.display = 'block';
                }
            });
        });

        document.addEventListener('click', e => {
            if (!e.target.closest('.multi-select-container')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(d => d.style.display = 'none');
            }
        });
    });
</script>
</body>
</html>
